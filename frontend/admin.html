<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Menu | Royal Restaurant</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .text-royal-gold { color: #D4AF37; }
    .bg-royal-gold { background-color: #D4AF37; }
    .border-royal-gold { border-color: #D4AF37; }
  </style>
</head>

<body class="bg-black text-gray-100 min-h-screen">

<!-- BRAND -->
<div class="absolute top-6 left-6">
  <h1 class="text-4xl font-serif text-royal-gold">Royal</h1>
</div>

<!-- ADMIN MENU -->
<section class="py-24">
  <div class="container mx-auto px-4 sm:px-6 md:px-6">

    <h2 class="text-5xl font-serif text-center text-royal-gold mb-10 text-3xl sm:text-4xl md:text-5xl">
      Admin Menu
    </h2>

    <!-- ADD BUTTON -->
    <div class="flex justify-center mb-10">
      <button
        id="open-add-modal-btn"
        class="bg-royal-gold text-black text-3xl sm:text-4xl font-bold w-16 h-16 sm:w-20 sm:h-20 rounded-full hover:bg-white transition">
        +
      </button>
    </div>

    <!-- CATEGORIES -->
    <div id="menu-categories" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-4 mb-12">
      <button data-category="all"
        class="menu-category-btn border-2 border-royal-gold text-royal-gold py-1 sm:py-2 rounded-full font-semibold hover:bg-royal-gold hover:text-black transition text-sm sm:text-base">
        All
      </button>
      <button data-category="food"
        class="menu-category-btn border-2 border-royal-gold text-royal-gold py-1 sm:py-2 rounded-full font-semibold hover:bg-royal-gold hover:text-black transition text-sm sm:text-base">
        Food
      </button>
      <button data-category="drinks"
        class="menu-category-btn border-2 border-royal-gold text-royal-gold py-1 sm:py-2 rounded-full font-semibold hover:bg-royal-gold hover:text-black transition text-sm sm:text-base">
        Drinks
      </button>
      <button data-category="desserts"
        class="menu-category-btn border-2 border-royal-gold text-royal-gold py-1 sm:py-2 rounded-full font-semibold hover:bg-royal-gold hover:text-black transition text-sm sm:text-base">
        Desserts
      </button>
    </div>

    <!-- MENU ITEMS -->
    <div id="menu-items-container"
      class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6 lg:gap-10"></div>

  </div>
</section>

<!-- MODAL -->
<div id="add-item-modal"
  class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50 px-2 sm:px-4">
  <div class="bg-gray-900 p-6 sm:p-8 rounded-2xl shadow-2xl w-full sm:w-11/12 md:w-1/2 lg:w-1/3 relative">

    <button id="close-add-modal-btn"
      class="absolute top-3 right-4 text-royal-gold text-2xl">&times;</button>

    <h3 class="text-2xl text-royal-gold mb-6 text-lg sm:text-xl md:text-2xl">Add / Edit Menu Item</h3>

    <form id="add-menu-item-form" class="grid gap-3 sm:gap-4">
      <input id="new-name" placeholder="Name" required
        class="p-2 sm:p-3 rounded text-black w-full" />

      <input id="new-description" placeholder="Description" required
        class="p-2 sm:p-3 rounded text-black w-full" />

      <input id="new-price" type="number" step="0.01" placeholder="Price" required
        class="p-2 sm:p-3 rounded text-black w-full" />

      <!-- CATEGORY SELECT -->
      <select id="new-category" required class="p-2 sm:p-3 rounded text-black w-full">
        <option value="food">Food</option>
        <option value="drinks">Drinks</option>
        <option value="desserts">Desserts</option>
      </select>

      <input id="new-image" type="file" accept="image/*"
        class="p-2 sm:p-3 rounded bg-white text-black w-full" />

      <button
        class="bg-royal-gold text-black py-2 sm:py-3 rounded font-semibold hover:bg-white transition w-full">
        Save Item
      </button>
    </form>

    <div id="add-item-message" class="text-green-500 mt-3 hidden"></div>
  </div>
</div>

<!-- SCRIPT -->
<script>
const container = document.getElementById("menu-items-container");
const modal = document.getElementById("add-item-modal");
const openBtn = document.getElementById("open-add-modal-btn");
const closeBtn = document.getElementById("close-add-modal-btn");
const form = document.getElementById("add-menu-item-form");
const categoryBtns = document.querySelectorAll(".menu-category-btn");

let allItems = [];
let activeCategory = "all";
let editingId = null;

// OPEN / CLOSE MODAL
openBtn.onclick = () => {
  modal.classList.remove("hidden");
  form.reset();
  editingId = null; // adding new product
};
closeBtn.onclick = () => modal.classList.add("hidden");

// FETCH MENU
async function fetchMenu() {
  const res = await fetch("/api/menu");
  const data = await res.json();
  allItems = data.data;
  filterItems();
}

// FILTER
categoryBtns.forEach(btn => {
  btn.onclick = () => {
    activeCategory = btn.dataset.category;
    categoryBtns.forEach(b => b.classList.remove("bg-royal-gold","text-black"));
    btn.classList.add("bg-royal-gold","text-black");
    filterItems();
  };
});

function filterItems() {
  const filtered =
    activeCategory === "all"
      ? allItems
      : allItems.filter(i =>
          i.category &&
          i.category.toLowerCase() === activeCategory
        );

  render(filtered);
}

// RENDER
function render(items) {
  container.innerHTML = "";
  items.forEach(item => {
    const div = document.createElement("div");
    div.className =
      "bg-gray-800 rounded-xl p-4 shadow-lg transition-all duration-500";

    div.innerHTML = `
      <div class="${!item.isAvailable ? "opacity-50 scale-95 grayscale" : ""}">
        <img src="${item.image}" class="w-full h-40 object-cover rounded mb-2" />
        <h3 class="text-xl text-royal-gold font-semibold">${item.name}</h3>
        <p class="text-gray-300 text-sm">${item.description}</p>
        <p class="text-white font-bold">$${item.price}</p>
      </div>

      <div class="flex justify-between mt-4">
        <button class="edit-btn text-blue-400" data-id="${item._id}">‚úèÔ∏è</button>
        <button class="toggle-btn ${item.isAvailable ? "text-green-500" : "text-red-500"}"
          data-id="${item._id}">
          ${item.isAvailable ? "üü¢" : "üî¥"}
        </button>
        <button class="delete-btn text-red-500" data-id="${item._id}">üóëÔ∏è</button>
      </div>
    `;
    container.appendChild(div);
  });

  attachActions(items);
}

// ACTIONS
function attachActions(items) {
  items.forEach(item => {

    document.querySelector(`.toggle-btn[data-id="${item._id}"]`).onclick =
      async () => {
        await fetch(`/api/menu/${item._id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ isAvailable: !item.isAvailable })
        });
        fetchMenu();
      };

    document.querySelector(`.delete-btn[data-id="${item._id}"]`).onclick =
      async () => {
        await fetch(`/api/menu/${item._id}`, { method: "DELETE" });
        fetchMenu();
      };

    // EDIT BUTTON (prefill modal)
    document.querySelector(`.edit-btn[data-id="${item._id}"]`).onclick = () => {
      editingId = item._id;
      modal.classList.remove("hidden");

      document.getElementById("new-name").value = item.name || "";
      document.getElementById("new-description").value = item.description || "";
      document.getElementById("new-price").value = item.price || "";
      document.getElementById("new-category").value = item.category || "food";
      document.getElementById("new-image").value = ""; // clear previous file
    };
  });
}

// SUBMIT FORM (Add / Edit using FormData)
form.onsubmit = async e => {
  e.preventDefault();

  const formData = new FormData();
  formData.append("name", document.getElementById("new-name").value.trim());
  formData.append("description", document.getElementById("new-description").value.trim());
  formData.append("price", parseFloat(document.getElementById("new-price").value));
  formData.append("category", document.getElementById("new-category").value);

  const imageFile = document.getElementById("new-image").files[0];
  if (imageFile) formData.append("image", imageFile);
  else if (!editingId) {
    alert("Please select an image for the new product.");
    return;
  }

  const url = editingId ? `/api/menu/${editingId}` : "/api/menu";
  const method = editingId ? "PATCH" : "POST";

  try {
    const res = await fetch(url, { method, body: formData });
    const json = await res.json();

    if (json.success) {
      fetchMenu();
      modal.classList.add("hidden");
      form.reset();
      editingId = null;
    } else {
      alert(json.message || "Error saving product.");
    }
  } catch (err) {
    console.error(err);
    alert("Error saving product.");
  }
};

fetchMenu();
</script>

</body>
</html>

